
generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x", "rhel-openssl-3.0.x", "rhel-openssl-1.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed password
  fullName  String?  @map("full_name")
  role      String   @default("staff") // 'admin', 'staff', 'agent'
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  agentProfile      Agent?
  accountingEntries Accounting[]
  reminders         Reminder[]

  @@map("users")
}

model Agent {
  id          String   @id @default(uuid())
  name        String
  type        String   // 'sub-agent', 'foreign'
  email       String?
  phone       String?
  address     String?
  contactInfo Json?    @map("contact_info") // For flexible storage
  userId      String?  @unique @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User?       @relation(fields: [userId], references: [id])
  candidates  Candidate[]

  @@map("agents")
}

model Candidate {
  id            String   @id @default(uuid())
  
  // 1. General Details
  registrationNumber String? @unique @map("registration_number") // Auto-generate or manual? User said "Registration Number", implies manual or system gen. Let's make it optional string for now.
  registrationDate DateTime? @map("registration_date") @default(now())
  fullName      String   @map("full_name")
  nameWithInitials String? @map("name_with_initials")
  nic           String?  @unique
  dob           DateTime?
  gender        String?  // SEX
  age           Int?     // Calculated or stored? User asked for field. Storing it.
  photo         String?  // URL to photo

  // 2. Personal Details
  homeTown      String?  @map("home_town")
  placeOfBirth  String?  @map("place_of_birth")
  gsSection     String?  @map("gs_section")
  policeArea    String?  @map("police_area")
  agaDivision   String?  @map("aga_division")
  nationality   String?
  religion      String?
  maritalStatus String?  @map("marital_status")
  contactNumber String?  @map("contact_number") // Mobile/Phone
  secondaryContactNumber String? @map("secondary_contact_number")
  address       String?  // Guardian Address or user address? User listed "Guardian Address" separately. This might be candidate's address.
  weight        Decimal? @db.Decimal(5, 2)
  height        Decimal? @db.Decimal(5, 2) // cm or feet? Storing as decimal.
  childrenCount Int?     @map("children_count")
  
  // Guardian
  guardianName  String?  @map("guardian_name")
  guardianAddress String? @map("guardian_address")
  guardianRelationship String? @map("guardian_relationship")
  guardianContact String? @map("guardian_contact")

  // 3. Passport Details
  passportNo    String   @unique @map("passport_no")
  passportIssuedDate DateTime? @map("passport_issued_date")
  passportExpDate   DateTime? @map("passport_exp_date")
  passportPlaceIssued String? @map("passport_place_issued")
  passportStatus      String? @map("passport_status") // 'In Custody', 'No'

  // 4. Job Details
  jobCountry    String?  @map("job_country")
  jobPost       String?  @map("job_post")
  jobSalary     Decimal? @db.Decimal(10, 2) @map("job_salary")
  contractPeriod String? @map("contract_period")
  experience    String?  @db.Text

  // 5. Education & Remarks
  remarks       String?  @db.Text

  // System
  agentId       String?  @map("agent_id")
  status        String   @default("Registered")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  agent      Agent?           @relation(fields: [agentId], references: [id])
  processing ProcessingStep[]
  accounting Accounting[]
  documents  Document[]

  @@map("candidates")
}

model ProcessingStep {
  id             String   @id @default(uuid())
  candidateId    String   @map("candidate_id")
  type           String   // Medical, Visa, Training, Embassy, Ticket
  status         String   // Pending, Completed, Failed
  notes          String?  @db.Text
  completionDate DateTime? @map("completion_date")
  createdAt      DateTime @default(now()) @map("created_at")

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("processing")
}

model Accounting {
  id          String   @id @default(uuid())
  candidateId String?  @map("candidate_id")
  type        String   // income, expense
  amount      Decimal  @db.Decimal(10, 2)
  description String?
  createdBy   String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  candidate Candidate? @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  user      User?      @relation(fields: [createdBy], references: [id])

  @@map("accounting")
}

model Document {
  id          String   @id @default(uuid())
  candidateId String   @map("candidate_id")
  name        String
  filePath    String   @map("file_path") // Path relative to /public/uploads
  fileType    String   @map("file_type")
  createdAt   DateTime @default(now()) @map("created_at")

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Reminder {
  id        String   @id @default(uuid())
  title     String
  dueDate   DateTime @map("due_date")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reminders")
}
